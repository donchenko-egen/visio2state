# visio2state
Назначение: создание программного кода на языке СИ для микроконтроллеров STM32

Исходные данные: графическое представление программного автомата fsa в Microsoft Visio.

Среда проектирования: страница документа  Microsoft Visio.

Способ трансляции: вызов макроса.

Результат:  файлы fsa.c и fsa.h 

Обязательное требование: разрешение работы макросов Microsoft Visio. 

Документы проекта включают два файла:  auto.vss  (фигуры) и auto.vsdm (документ Visio с поддержкой макросов).
Документы  auto.vss  и auto.vsdm необходимо разместить в любой папке вашего проекта. 

После запуска «трансляции» (вызова макроса) в этой же папке появляются файлы fsa.c (код автоматов) и fsa.h (описание функций и переменных).

В проекте auto.vsdm выложена полностью рабочая, хотя и упрощенная версия. Работа автомата проверена на реальном оборудовании.

Подключение автомата в проект STM32:

 fsa_init(); // All automate init 
 
 // USER CODE END 2  
 
 // Infinite loop 
 
 // USER CODE BEGIN WHILE 
 
  while (1)
  
  {
  
    fsa();  // Cистемный автомат
    
    // USER CODE END WHILE 

    // USER CODE BEGIN 3 
    
  }

Для работы WAIT необходимо

void SysTick_Handler(void)

{

  // USER CODE BEGIN SysTick_IRQn 0 
  
  SW_Systick();
  
  // USER CODE END SysTick_IRQn 0 
  
....

Создание собственного автомата. 

На листе A0 проекта размещена фигура SW_Auto. Именно эта фигуры на листе A0 объявляет содержимое листа A0 автоматом. На листе A1 следующий автомат.  Обязателен ввод в поле  SW_Auto только имени автомата (в примере aSystem), в среде СИ будет создана переменная с тем же именем.  
На листе A0 проекта размещена фигура SW_Error. Результаты трансляции (в том числе ошибки) выводятся в тексте фигуры.
На листе A0 проекта размещена фигура SW_Header. Содержимое текста фигуры автоматически копируется в файл fsa.h   Рекомендуется отключить автоввод заглавной буквы в настройках Visio.
Подкрашенная желтым кнопка «Пуск транслятора» связана с макросом. Срабатывает от двойного клика, но запускать макрос можно и вручную.

Для создания вашего проекта удалите из образца ненужные вершины (состояния) SW_State и переходы (дуги).
Вставьте новую вершину и измените ее номер на требуемый (уникальный).

В верхнюю ячейку SW_State вводится имя вершины.  Не обязательно. Используется для комментариев, требования к оформлению отсутствуют.

Вторая сверху ячейка – действия, выполняемые при входе в вершину, однократно.  Допустимы любые СИ конструкции.

Третья сверху ячейка – действия, выполняемые при нахождении в данном состоянии, многократно, при каждом запуске функции автомата 
fsa();  // Cистемный автомат. 
Допустимы любые СИ конструкции.

Четвертая сверху ячейка – действия, выполняемые при выходе из состояния, однократно.  Допустимы любые СИ конструкции.
Фигура SW_State автоматически изменяет размер при расширении соответствующих тестовых полей.

Для соединения вершин используют дуги SW_conn. Визуальная толщина  линии дуги  соответствует приоритету – соединения при помощи SW_connHi обладают наивысшим приоритетом, SW_connLo – низшим. Линии одинаковой толщины, созданные ранее имеют более высокий приоритет по сравнению с более поздними по времени создания, но таких дуг лучше не создавать. Фактически приоритет означает порядок размещения переходов в результирующей цепочке команд:

if () else if () else if () … 

Каждая дуга имеет блок условия/действия.
В числителе дроби записано условие перехода, допустимы конструкции языка СИ и макрокоманда WAIT(время_в_мс), с учетом того что блок будет размещен внутри оператора if. Например, условие uX1 приведет к появлению перехода
if (uX1) 
В знаменателе допустимы любые СИ конструкции, они будут размещены в теле оператора if.

Для предотвращения загромождения проекта длинными дугами через весь чертеж введен блок SW_Goto. В его текстовое поле вводится номер связанной (существкющей) вершины. 
Внутрь текстового поля SW_Goto можно поместить команду "OLD". При исполнении этой команды автомат вернется на предыдущую вершину. Допустимо 5 (пять) вложений команды "OLD".
Внутрь текстового поля SW_Goto, установленного в начало дуги,  можно поместить команду "ALL". При исполнении условия перехода автомат перейдет на указанную в конце дуги вершину с любой другой вершины автомата.

На дугах переходов может быть размещена команда WAIT(время задержки) 
Обязательным условием для функционирования WAIT является размещение в функцию обработки системного времени systick() вашего микроконтроллера процедуры SW_Systick();
Использование задержки полностью автоматизировано. Достаточно указать на исходящей дуге команду WAIT(число) , в том числе с использованием других переменных в качестве условия перехода и транслятор предоставит все необходимые для реализации задержки средства. 

Кодировка результирующих файлов: utf-8.
Если по какой-то причине  utf-8 не устраивает, есть три пути решения:
1.	Поменять в макросе     Set fileStream = fso.CreateTextFile(filePath, True, True)
на     Set fileStream = fso.CreateTextFile(filePath, True, False)
2.	Воспользоваться Notepad ++
